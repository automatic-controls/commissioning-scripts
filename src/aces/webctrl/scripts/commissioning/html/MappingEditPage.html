<!--
  BSD 3-Clause License
  Copyright (c) 2022, Automatic Controls Equipment Systems, Inc.
  Contributors: Cameron Vogt (@cvogt729)
-->
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>
      Mapping Editor
    </title>
    <link rel="stylesheet" type="text/css" href="../../../../../../root/webapp/css/main.css"/>
    <script>
      function registerChange(){
        changes = true;
        saveButton.style.backgroundColor = "steelblue";
      }
      function unregisterChange(){
        changes = false;
        saveButton.style.backgroundColor = "initial";
      }
      function checkSave(){
        if (changes){
          alert("Please save changes before continuing.");
          return false;
        }else{
          return true;
        }
      }
      function resize(input){
        const styles = window.getComputedStyle(input);
        hiddenSpan.style.fontFamily = styles.fontFamily;
        hiddenSpan.style.fontSize = styles.fontSize;
        hiddenSpan.style.fontStyle = styles.fontStyle;
        hiddenSpan.style.fontWeight = styles.fontWeight;
        hiddenSpan.style.letterSpacing = styles.letterSpacing;
        hiddenSpan.style.textTransform = styles.textTransform;
        hiddenSpan.style.borderLeftWidth = styles.borderLeftWidth;
        hiddenSpan.style.borderRightWidth = styles.borderRightWidth;
        hiddenSpan.style.paddingLeft = styles.paddingLeft;
        hiddenSpan.style.paddingRight = styles.paddingRight;
        hiddenSpan.innerText = input.value;
        input.style.width = hiddenSpan.offsetWidth+"px";
      }
      function prepareTagExport(){
        const tags = {};
        for (const tr of tagTable.getElementsByTagName("TR")){
          tags[tr.semanticTag] = tr.semanticExpression;
        }
        if (Object.keys(tags).length===0){
          alert("Please add a semantic tag before exporting.");
          return false;
        }
        exportTagsButton.setAttribute("href", "data:text/plain;charset=utf-8,"+encodeURIComponent(JSON.stringify(tags)));
        return true;
      }
      async function importTags(){
        if (fileField.value.length>0){
          const file = fileField.files[0];
          fileField.value = null;
          try{
            const tags = JSON.parse(await file.text());
            clearTags();
            for (const [key,value] of Object.entries(tags)){
              addTag(key,value);
            }
          }catch(e){
            console.log(e);
            alert("Imported tag file is corrupt.");
          }
        }
      }
      function clearTags(){
        if (tagTable.firstElementChild){
          tagTable.replaceChildren();
          registerChange();
        }
      }
      function addTag(tag,expr){
        if (tag.length>0){
          registerChange();
          const tr = document.createElement("TR");
          
        }
      }
    </script>
  </head>
  <body>
    <div style="text-align:center">
      <h1>Mapping Editor</h1>
      <form id="mainForm" method="POST" action="__PREFIX__/MappingEditor?cmd=save&ID=__MAPPING_ID__" onsubmit="return false">
        <div class="row">
          <div class="column">
            <table>
              <thead><tr>
                <th>Semantic Tag</th>
                <th><a target="_blank" href="https://docs.oracle.com/en/java/javase/18/docs/api/java.base/java/util/regex/Pattern.html">Expression</a></th>
                <th>Actions</th>
              </tr></thead>
              <tbody id="tagTable"></tbody>
              <tbody>
                <td><input class="c" type="text" id="newTagField" oninput="resize(this)"></td>
                <td><input class="c" type="text" id="newExprField" oninput="resize(this)"></td>
                <td><button type="button" class="e" onclick="addTag(newTagField.value,newExprField.value);newTagField.value='';newExprField.value='';">Create</button></td>
              </tbody>
            </table>
          </div>
          <div class="column">
            
          </div>
        </div>
        <br>
        <button type="button" class="e" id="clearTagsButton" onclick="clearTags()">Clear Tags</button>
        <a class="e" id="exportTagsButton" href="#" download="tags.json" onclick="prepareTagExport()">Export Tags</a>
        <button type="button" class="e" id="importTagsButton" onclick="fileField.click()">Import Tags</button>
        <a class="e" href="__PREFIX__/MappingPreview?ID=__MAPPING_ID__" onclick="return checkSave()">Preview Mapping Resolution</a>
        <button type="submit" class="e" id="saveButton">Save Data</button>
      </form>
      <br>
      <a class="e" href="__PREFIX__/Scripts">Scripts</a>
      <a class="e" href="__PREFIX__/ArchivedTests">Archived Tests</a>
      <a class="e" href="__PREFIX__/ScheduledTests">Scheduled Tests</a>
      <a class="e" href="__PREFIX__/SemanticMappings">Semantic Mappings</a>
      <a class="e" href="__PREFIX__/ErrorLog">Error Log</a>
      <a class="e" href="__DOC_LINK__" target="_blank">Documentation</a>
      <input type="file" id="fileField" accept=".json" style="display:none" oninput="importTags();">
      <span id="hiddenSpan" style="min-width:6em;color:black;display:inline-block;position:absolute;left:-100000px;white-space:pre"></span>
    </div>
    <script>
      var changes;
      var prompt = true;
      resize(newTagField);
      resize(newExprField);
      //__SCRIPT__
      unregisterChange();
      window.onbeforeunload = ()=>{
        if (prompt && changes){
          return "Changes remain unsaved. Are you sure you want to leave?";
        }
      };
      saveButton.onclick = ()=>{
        
      };
    </script>
  </body>
</html>